<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Predikzioa: Zizak - Euskal Herria / Predicci√≥n: Setas - Pa√≠s Vasco</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    .card-chance-Alta { background-image: linear-gradient(to right, #D1FAE5, #34D399); }
    .card-chance-Media { background-image: linear-gradient(to right, #FEF3C7, #F59E0B); }
    .card-chance-Baja { background-image: linear-gradient(to right, #FEE2E2, #F87171); }
    .loading-spinner { border: 4px solid rgba(0, 0, 0, 0.1); border-left-color: #4CAF50; border-radius: 50%; width: 24px; height: 24px; animation: spin 1s linear infinite; }
    @keyframes spin { to { transform: rotate(360deg); } }
    .score-breakdown-details { animation: fadeIn 0.3s ease-in-out; }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(-5px); } to { opacity: 1; transform: translateY(0); } }
    .score-breakdown li { margin-left: 1.5rem; position: relative; }
    .score-breakdown li::before { content: '‚úÖ'; position: absolute; left: -1.5rem; }
    .score-breakdown.no-score li::before { content: '‚ùå'; }
    .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0, 0, 0, 0.4); padding-top: 60px; }
    .modal-content { background-color: #fefefe; margin: 5% auto; padding: 20px; border: 1px solid #888; width: 90%; max-width: 800px; border-radius: 1rem; position: relative; }
    .close { color: #aaa; float: right; font-size: 28px; font-weight: bold; }
    .close:hover, .close:focus { color: black; text-decoration: none; cursor: pointer; }
    details > summary { cursor: pointer; }
    .chip { display: inline-flex; align-items: center; gap: .4rem; padding: .15rem .5rem; border-radius: 9999px; font-weight: 600; font-size: .75rem; }
  </style>
</head>
<body class="bg-green-50 min-h-screen p-6 font-sans">
  <header class="text-center mb-8 relative">
    <h1 class="text-4xl font-extrabold text-green-800 mb-2">üçÑ Zizen Aparizioa - Euskal Herria üå≤<br /><span class="text-2xl">Predicci√≥n de Setas - Pa√≠s Vasco</span></h1>
    <p class="text-lg text-gray-600">Probabilitate orokorra eta espezie egokiena baldintzaren arabera.<br />Probabilidad general y especie m√°s probable seg√∫n condiciones.</p>
    <button id="help-button" class="absolute top-2 right-2 text-gray-400 hover:text-green-600 text-3xl font-bold leading-none" aria-label="Laguntza / Ayuda">&#9432;</button>
  </header>
  <div id="notification" class="max-w-6xl mx-auto mb-4 hidden p-4 rounded-md text-sm"></div>
  <div class="max-w-6xl mx-auto mb-8 grid grid-cols-1 md:grid-cols-3 gap-6">
    <!-- A√±adir nueva ubicaci√≥n -->
    <div class="bg-white shadow-lg rounded-xl p-5 md:col-span-1">
      <h3 class="text-xl font-bold text-gray-800 mb-4">üìç Leku berria gehitu / A√±adir nueva ubicaci√≥n</h3>
      <div id="add-location-form" class="space-y-4 flex-col">
        <div class="flex-1 flex gap-2">
          <input type="text" id="location-name" placeholder="Idatzi lekua (adib. Aralar, Gipuzkoa) / Escribe el lugar (ej. Aralar, Guip√∫zcoa)" required class="w-full p-2 border border-gray-300 rounded-md" />
          <button type="button" id="search-button" class="bg-green-600 text-white px-6 py-2 rounded-md font-semibold hover:bg-green-700 transition duration-300 ease-in-out">Bilatu / Buscar</button>
        </div>
        <details class="bg-green-50 rounded-md p-3 border border-green-200">
          <summary class="font-semibold text-green-800">Habitat mota (hautazkoa) / Tipo de h√°bitat (opcional)</summary>
          <div class="mt-3 grid grid-cols-1 sm:grid-cols-3 gap-3 text-sm">
            <label class="block">
              <span class="text-gray-700">Habitat mota</span>
              <select id="habitat-select" class="mt-1 block w-full border rounded-md p-2">
                <option value="">(zehaztua gabe)</option>
                <option value="hayedo">Hariztia / Hayedo</option>
                <option value="robledal_atlantico">Harizti atlantikoa / Robledal atl√°ntico</option>
                <option value="pinar_silvestre">Pinudi / Pinar de pino silvestre</option>
                <option value="carrascal">Arbarra / Carrascal</option>
                <option value="mixto_caducifolio">Nahasketa hosto-erorkorrekoa / Mixto caducifolio</option>
              </select>
            </label>
            <label class="block">
              <span class="text-gray-700">Zuhaitzen adina</span>
              <select id="age-select" class="mt-1 block w-full border rounded-md p-2">
                <option value="">(zehaztua gabe)</option>
                <option value="maduro">Matura (>80 urte) / Maduro (>80 a√±os)</option>
                <option value="medio">Ertaina (40‚Äì80) / Medio (40‚Äì80)</option>
                <option value="joven">Gaztea (<40) / Joven (<40)</option>
              </select>
            </label>
            <label class="block">
              <span class="text-gray-700">Lurra</span>
              <select id="soil-select" class="mt-1 block w-full border rounded-md p-2">
                <option value="">(zehaztua gabe)</option>
                <option value="acidofilo">Azidoa / √Åcido</option>
                <option value="basofilo">Basikoa / B√°sico</option>
              </select>
            </label>
          </div>
        </details>
        <div id="search-results" class="mt-2 hidden">
          <p id="search-status" class="text-sm text-gray-500 mb-2"></p>
          <button type="button" id="add-location-btn" class="bg-blue-600 text-white px-6 py-2 rounded-md font-semibold hover:bg-blue-700 transition duration-300 ease-in-out hidden">Gehitu "Nire Lekuetara" / A√±adir a "Mis Lugares"</button>
        </div>
      </div>
    </div>
    <!-- Fase Lunar -->
    <div id="moon-phase-card" class="bg-white shadow-lg rounded-xl p-5 md:col-span-1 flex flex-col justify-center items-center">
      <h3 class="text-xl font-bold text-gray-800 mb-2 text-center">Ilargi-fasea / Fase Lunar</h3>
      <div class="flex items-center space-x-2">
        <span id="moon-emoji" class="text-4xl"></span>
        <div class="text-gray-700">
          <p id="moon-phase-name" class="font-semibold text-lg"></p>
          <p id="next-full-moon" class="text-xs"></p>
        </div>
      </div>
    </div>
    <!-- Parke Mikologikoak / Parques Micol√≥gicos -->
    <div class="bg-white shadow-lg rounded-xl p-5 md:col-span-1">
      <h3 class="text-xl font-bold text-gray-800 mb-4">Parke Mikologikoak / Parques Micol√≥gicos</h3>
      <p class="text-sm text-gray-600 mb-2">Egiaztatu zizen parteak.<br />Consulta los partes de setas que publican los parques.</p>
      <div class="flex flex-wrap gap-2 justify-start">
        <a href="https://parquemicologicoultzama.com/" target="_blank" class="px-4 py-2 bg-green-200 text-green-800 rounded-md font-semibold hover:bg-green-300 transition-colors duration-200 text-sm">Ultzama</a>
        <a href="https://www.parquemicologicoerro.com/" target="_blank" class="px-4 py-2 bg-green-200 text-green-800 rounded-md font-semibold hover:bg-green-300 transition-colors duration-200 text-sm">Erro-Arribe</a>
      </div>
    </div>
  </div>
  <!-- Kontrolak / Controles -->
  <div id="controls" class="bg-white shadow-lg rounded-xl p-4 mb-8 max-w-6xl mx-auto flex flex-wrap gap-4 items-center justify-between">
    <div class="flex flex-wrap gap-2 items-center">
      <span class="font-semibold text-gray-700">Iragazkia:</span>
      <button data-filter="all" class="filter-btn bg-gray-200 hover:bg-gray-300 text-gray-800 px-3 py-1 rounded-md text-sm transition-colors duration-200">Guztiak / Todas</button>
      <button data-filter="Alta" class="filter-btn bg-green-200 hover:bg-green-300 text-green-800 px-3 py-1 rounded-md text-sm transition-colors duration-200">Alta / Handia</button>
      <button data-filter="Media" class="filter-btn bg-yellow-200 hover:bg-yellow-300 text-yellow-800 px-3 py-1 rounded-md text-sm transition-colors duration-200">Media / Ertaina</button>
      <button data-filter="Baja" class="filter-btn bg-red-200 hover:bg-red-300 text-red-800 px-3 py-1 rounded-md text-sm transition-colors duration-200">Baja / Baxua</button>
    </div>
    <div class="flex flex-wrap gap-2 items-center">
      <span class="font-semibold text-gray-700">Ordenatu:</span>
      <button data-sort="name" class="sort-btn bg-gray-200 hover:bg-gray-300 text-gray-800 px-3 py-1 rounded-md text-sm transition-colors duration-200">Izena / Nombre</button>
      <button data-sort="chance" class="sort-btn bg-gray-200 hover:bg-gray-300 text-gray-800 px-3 py-1 rounded-md text-sm transition-colors duration-200">Probabilitatea / Probabilidad</button>
    </div>
  </div>
  <!-- Grid -->
  <div id="grid-container" class="max-w-6xl mx-auto">
    <p id="loading-message" class="text-center text-gray-700 text-lg hidden">Kargatzen ari da... <span class="loading-spinner inline-block align-middle ml-2"></span><br />Cargando predicciones... <span class="loading-spinner inline-block align-middle ml-2"></span></p>
    <div id="grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6"></div>
    <div id="welcome-message" class="hidden text-center max-w-2xl mx-auto p-8 bg-white shadow-lg rounded-xl">
      <h2 class="text-2xl font-bold text-green-700 mb-4">Ongi etorri! / ¬°Bienvenido/a!</h2>
      <p class="text-gray-600">Hasieran zure leku gogokoak gehituz planifikatu zure hurrengo mendiko irteera.<br />Empieza a planificar tu pr√≥xima salida al monte a√±adiendo tus lugares favoritos con el buscador de arriba. Las ubicaciones que a√±adas se guardar√°n autom√°ticamente en tu navegador.</p>
    </div>
  </div>
  <!-- Modal de ayuda -->
  <div id="help-modal" class="modal" role="dialog" aria-modal="true" aria-labelledby="help-title">
    <div class="modal-content">
      <span class="close" aria-label="Cerrar">&times;</span>
      <h2 id="help-title" class="text-2xl font-bold text-green-800 mb-4">Aplikazio hau / Acerca de esta aplicaci√≥n</h2>
      <p class="mb-4 text-gray-700">Aplikazio honek zizak aurkitzeko probabilitatea kalkulatzen du, Euskal Herriko iparraldeko meteorologia eta habitat tipikoen datuak erabiliz.<br />Esta aplicaci√≥n estima la probabilidad de encontrar setas combinando condiciones meteorol√≥gicas recientes y un modelo heur√≠stico ajustado a h√°bitats t√≠picos del norte de Navarra.</p>
      <h3 class="font-bold text-lg mb-2">Nola kalkulatzen da probabilitatea? / ¬øC√≥mo se calcula la probabilidad?</h3>
      <ul class="list-disc list-inside space-y-2 mb-4 text-sm text-gray-700">
        <li><b>Luraren hezetasuna (SMI):</b> euri eta ET0 batzen ditu, lurzoruko ur erabilgarria simulatzeko.</li>
        <li><b>Buleta post-eurian:</b> ‚â•25&nbsp;mm 48&nbsp;h-ean, bonusa ematen da 6‚Äì12 egun geroago.</li>
        <li><b>Tenperatura egokia:</b> 8‚Äì18&nbsp;¬∞C aldarrikatzen da; beroa (>22&nbsp;¬∞C) penalizatzen da.</li>
        <li><b>Airerik hezea (T‚àíTd):</b> zenbat eta hurbilago egon T lurzoruarekiko, hobe.</li>
        <li><b>Kendu egiten da:</b> bero luzea (m√°x. ‚â•24&nbsp;¬∞C), haizea beroarekin eta izotzak.</li>
        <li><b>Leunagoa:</b> 3 eguneko filtroa "diente de sierra" saiheste ala.</li>
        <li><b>Habitat (hautazkoa):</b> habitat mota, zuhaitzen adina eta lurzoruko azidotasunak biderkatzailea aplikatzen du (¬±10‚Äì15%).</li>
      </ul>
      <h3 class="font-bold text-lg mb-2">Modo espeziea / Modo especie</h3>
      <ul class="list-disc list-inside space-y-2 mb-4 text-sm text-gray-700">
        <li><b>Probabilitate erlatiboa</b> kalkulatzen da bost taldeentzat: <b>Boletus</b>, <b>Cantharellus</b>, <b>N√≠scalos</b>, <b>Lepista nuda</b> eta <b>Hydnum repandum</b>, estazioa, tenperatura, luraren hezetasuna, T‚àíTd eta habitatetan oinarrituta.</li>
        <li><b>"Hoberen gaur"</b> etiketa gisa agertzen da lekuaren izaren azpian.</li>
        <li>Grafikoa: <b>barrak egun bakoitzeko (balio absolutuak)</b> + <b>lerroa probabilitate oinarriarekin</b> magnitudea ikusteko.</li>
      </ul>
      <p class="mt-6 text-xs text-gray-500 italic">Barkatu eta ez jan inoiz identifikazio oso gabe. Tresna hau orientatzailea da.<br />Recolecta con respeto y jam√°s consumas sin identificaci√≥n total. Esta herramienta es orientativa.</p>
    </div>
  </div>
<script>
  // === Constantes de APIs ===
  const OPENMETEO_API_URL = "https://api.open-meteo.com/v1/forecast";
  const NOMINATIM_API_URL = "https://nominatim.openstreetmap.org/search";
  const OPENTOPO_API_URL = "https://api.opentopodata.org/v1/aster30m";

  // === Bounding Box ampliado: incluye todo el entorno natural favorable ===
  const REGION_BBOX = {
    minLon: -4.0,   // Oeste: incluye Bizkaia, Lapurdi
    maxLon: 2.0,    // Este: hasta los Pirineos aragoneses
    minLat: 42.0,   // Sur: zona pirenaica
    maxLat: 44.0    // Norte: costa vasca y francesa
  };

  // === Ubicaciones por defecto ===
  const DEFAULT_LOCATIONS = [
    { name: "Altsasu", lat: 42.9078, lon: -2.1706, habitat: "hayedo", ageClass: "maduro", soilAcidity: "acidofilo" },
    { name: "Etxalar", lat: 43.2336728, lon: -1.6406026, habitat: "robledal_atlantico", ageClass: "medio", soilAcidity: "basofilo" },
    { name: "Leitza", lat: 43.0786, lon: -1.9146, habitat: "mixto_caducifolio", ageClass: "joven", soilAcidity: "acidofilo" },
    { name: "Ultzama", lat: 43.0095198, lon: -1.6845978, habitat: "hayedo", ageClass: "maduro", soilAcidity: "acidofilo" },
    { name: "Zubiri", lat: 42.8969, lon: -1.5091, habitat: "pinar_silvestre", ageClass: "medio", soilAcidity: "basofilo" },
    { name: "Aralar", lat: 43.1833, lon: -2.1833, habitat: "hayedo", ageClass: "maduro", soilAcidity: "acidofilo" },
    { name: "Iturregi", lat: 43.2500, lon: -1.4500, habitat: "robledal_atlantico", ageClass: "medio", soilAcidity: "basofilo" }
  ];
  let LOCATIONS = [];
  let currentFilter = 'all';
  let currentSort = 'name';
  let allForecastData = [];

  // === Emojis de tiempo ===
  const WEATHER_ICONS = {
    0: '‚òÄÔ∏è', 1: 'üå§Ô∏è', 2: '‚õÖ', 3: '‚òÅÔ∏è', 45: 'üå´Ô∏è', 48: 'üå´Ô∏è', 51: 'üåßÔ∏è', 53: 'üåßÔ∏è', 55: 'üåßÔ∏è',
    56: 'üåßÔ∏è', 57: 'üåßÔ∏è', 61: 'üå¶Ô∏è', 63: 'üåßÔ∏è', 65: '‚õàÔ∏è', 66: 'üå®Ô∏è', 67: 'üå®Ô∏è', 71: 'üå®Ô∏è',
    73: 'üå®Ô∏è', 75: 'üå®Ô∏è', 77: 'üå®Ô∏è', 80: 'üåßÔ∏è', 81: 'üåßÔ∏è', 82: '‚õàÔ∏è', 85: 'üå®Ô∏è', 86: 'üå®Ô∏è',
    95: 'üå©Ô∏è', 96: '‚õàÔ∏è', 99: '‚õàÔ∏è', default: '‚ùì'
  };

  // === Fases lunares ===
  const MOON_PHASES = [
    { name: "Ilargi Berria", emoji: "üåë" },
    { name: "Ilargi Heldua", emoji: "üåí" },
    { name: "Hilabete Erdira", emoji: "üåì" },
    { name: "Ilargi Giboso Heldua", emoji: "üåî" },
    { name: "Ilargi Betia", emoji: "üåï" },
    { name: "Ilargi Giboso Korea", emoji: "üåñ" },
    { name: "Hilabete Erdira", emoji: "üåó" },
    { name: "Ilargi Korea", emoji: "üåò" }
  ];

  // === Especies (perfiles heur√≠sticos) ===
  const SPECIES = {
    boletus: {
      key: 'boletus', label: 'Boletus gr. edulis', color: '#047857', light: '#D1FAE5',
      habitats: { hayedo: 1.20, robledal_atlantico: 1.15, mixto_caducifolio: 1.1, pinar_silvestre: 0.95, carrascal: 0.85 },
      temp: [10, 18], smi: [0.55, 0.75],
      seasonWeight: function(m) { return (m >= 8 && m <= 10) ? 1 : (m === 7 || m === 11 ? 0.6 : 0.2); },
      dewBias: 0.7, windPenalty: 0.6
    },
    cantharellus: {
      key: 'cantharellus', label: 'Cantharellus cibarius', color: '#CA8A04', light: '#FEF3C7',
      habitats: { hayedo: 1.10, robledal_atlantico: 1.10, mixto_caducifolio: 1.1, pinar_silvestre: 1.00, carrascal: 0.9 },
      temp: [8, 20], smi: [0.6, 0.85],
      seasonWeight: function(m) { return (m >= 5 && m <= 10) ? 1 : (m === 4 || m === 11 ? 0.6 : 0.2); },
      dewBias: 1.0, windPenalty: 0.4
    },
    lactarius: {
      key: 'lactarius', label: 'N√≠scalos (Lactarius gr. deliciosus)', color: '#B91C1C', light: '#FEE2E2',
      habitats: { hayedo: 0.95, robledal_atlantico: 1.00, mixto_caducifolio: 1.0, pinar_silvestre: 1.20, carrascal: 0.95 },
      temp: [9, 16], smi: [0.5, 0.7],
      seasonWeight: function(m) { return (m >= 8 && m <= 10) ? 1 : (m === 7 || m === 11 ? 0.7 : 0.2); },
      dewBias: 0.6, windPenalty: 0.5
    },
    lepista_nuda: {
      key: 'lepista_nuda', label: 'Lepista nuda (pie azul)', color: '#6D28D9', light: '#EDE9FE',
      habitats: { hayedo: 1.05, robledal_atlantico: 1.05, mixto_caducifolio: 1.1, pinar_silvestre: 1.00, carrascal: 0.9 },
      temp: [4, 12], smi: [0.6, 0.8],
      seasonWeight: function(m) { return (m === 10 || m === 11) ? 1 : (m === 0 || m === 9 ? 0.7 : 0.2); },
      dewBias: 0.9, windPenalty: 0.5
    },
    hydnum_repandum: {
      key: 'hydnum_repandum', label: 'Hydnum repandum (lengua de vaca)', color: '#9A3412', light: '#FFEDD5',
      habitats: { hayedo: 1.15, robledal_atlantico: 1.10, mixto_caducifolio: 1.1, pinar_silvestre: 0.95, carrascal: 0.9 },
      temp: [6, 15], smi: [0.6, 0.8],
      seasonWeight: function(m) { return (m >= 8 && m <= 10) ? 1 : (m === 7 || m === 11 ? 0.6 : 0.2); },
      dewBias: 0.8, windPenalty: 0.5
    }
  };

  // === UI helpers ===
  function showNotification(message, type) {
    if (!type) type = 'info';
    const notification = document.getElementById('notification');
    notification.textContent = message;
    if (type === 'error') {
      notification.className = 'max-w-6xl mx-auto mb-4 p-4 rounded-md text-sm bg-red-100 text-red-800';
    } else if (type === 'warning') {
      notification.className = 'max-w-6xl mx-auto mb-4 p-4 rounded-md text-sm bg-yellow-100 text-yellow-800';
    } else {
      notification.className = 'max-w-6xl mx-auto mb-4 p-4 rounded-md text-sm bg-blue-100 text-blue-800';
    }
    notification.classList.remove('hidden');
    setTimeout(function() {
      notification.classList.add('hidden');
    }, 5000);
  }

  function slugify(s) {
    return String(s).toLowerCase().replace(/[^a-z0-9]+/g, '-');
  }

  function todayLocalYYYYMMDD() {
    const d = new Date();
    d.setMinutes(d.getMinutes() - d.getTimezoneOffset());
    return d.toISOString().slice(0, 10);
  }

  function getWeatherIcon(weatherCode) {
    return WEATHER_ICONS[weatherCode] || WEATHER_ICONS.default;
  }

  // === Fetch meteorolog√≠a ===
  async function fetchWeather(lat, lon, pastDays, forecastDays) {
    if (!pastDays) pastDays = 14;
    if (!forecastDays) forecastDays = 9;

    const cacheKey = 'weather_' + lat + '_' + lon + '_' + pastDays + '_' + forecastDays;
    const cachedData = localStorage.getItem(cacheKey);
    const cacheTime = localStorage.getItem(cacheKey + '_time');
    const cacheDuration = 6 * 60 * 60 * 1000; // 6 horas

    if (cachedData && cacheTime && (Date.now() - parseInt(cacheTime)) < cacheDuration) {
      showNotification('Datos cacheatutakoak erabiltzen. / Usando datos meteorol√≥gicos cacheados.', 'info');
      return JSON.parse(cachedData);
    }

    if (!navigator.onLine) {
      if (cachedData) {
        showNotification('Konexio gabe, cachea erabiltzen. / Sin conexi√≥n, usando datos cacheados.', 'warning');
        return JSON.parse(cachedData);
      }
      showNotification('Ezin izan dira datuak kargatu. / Error al obtener datos meteorol√≥gicos.', 'error');
      throw new Error('Offline');
    }

    const url = OPENMETEO_API_URL + '?latitude=' + lat + '&longitude=' + lon +
      '&past_days=' + pastDays + '&forecast_days=' + forecastDays +
      '&hourly=temperature_2m,relative_humidity_2m,precipitation,dew_point_2m,weather_code,wind_speed_10m,et0_fao_evapotranspiration' +
      '&timezone=Europe%2FMadrid';

    try {
      const r = await fetch(url);
      if (!r.ok) throw new Error('HTTP ' + r.status);
      const data = await r.json();
      localStorage.setItem(cacheKey, JSON.stringify(data));
      localStorage.setItem(cacheKey + '_time', Date.now().toString());
      return data;
    } catch (e) {
      if (cachedData) {
        showNotification('Errorea datu berriak eskuratzean, cachea erabiltzen. / Error al obtener datos nuevos, usando datos cacheados.', 'warning');
        return JSON.parse(cachedData);
      }
      showNotification('Errorea datu meteorologikoak eskuratzean. / Error al obtener datos meteorol√≥gicos.', 'error');
      throw e;
    }
  }

  async function fetchAltitude(lat, lon) {
    try {
      const url = OPENTOPO_API_URL + '?locations=' + lat + ',' + lon;
      const r = await fetch(url);
      const d = await r.json();
      if (d.results && d.results.length > 0) {
        return d.results[0].elevation || null;
      }
      return null;
    } catch (e) {
      console.warn('Altitud KO', e);
      return null;
    }
  }

  // === Preproceso diario ===
  function processDailyData(data) {
    const days = {};
    for (let i = 0; i < data.hourly.time.length; i++) {
      const time = data.hourly.time[i];
      const date = time.split("T")[0];
      if (!days[date]) {
        days[date] = {
          temps: [], rain_for_day: 0, humidities: [], dew_points: [],
          weather_codes: [], wind_speeds: [], temp_max: -Infinity, et0: []
        };
      }
      const vals = days[date];
      vals.temps.push(data.hourly.temperature_2m[i]);
      vals.humidities.push(data.hourly.relative_humidity_2m[i]);
      vals.dew_points.push(data.hourly.dew_point_2m[i]);
      vals.rain_for_day += data.hourly.precipitation[i] || 0;
      vals.weather_codes.push(data.hourly.weather_code[i]);
      vals.wind_speeds.push(data.hourly.wind_speed_10m[i]);
      vals.et0.push(data.hourly.et0_fao_evapotranspiration[i] || 0);
      if (data.hourly.temperature_2m[i] > vals.temp_max) vals.temp_max = data.hourly.temperature_2m[i];
    }

    return Object.keys(days).map(function(date) {
      const vals = days[date];
      return {
        date: date,
        temps: vals.temps,
        humidities: vals.humidities,
        rain_for_day: vals.rain_for_day,
        dew_points: vals.dew_points,
        wind_speeds: vals.wind_speeds,
        et0: vals.et0,
        temp_min: Math.min.apply(null, vals.temps),
        temp_max: vals.temp_max,
        avg_humidity: vals.humidities.reduce(function(a, b) { return a + b; }, 0) / vals.humidities.length || 0,
        avg_dew_point: vals.dew_points.reduce(function(a, b) { return a + b; }, 0) / vals.dew_points.length || 0,
        avg_wind_speed: vals.wind_speeds.reduce(function(a, b) { return a + b; }, 0) / vals.wind_speeds.length || 0,
        avg_et0: vals.et0.reduce(function(a, b) { return a + b; }, 0) / vals.et0.length || 0,
        weather_code: getDominantWeatherCode(vals.weather_codes)
      };
    });
  }

  function getDominantWeatherCode(codes) {
    const counts = {};
    for (let i = 0; i < codes.length; i++) {
      const c = codes[i];
      counts[c] = (counts[c] || 0) + 1;
    }
    const sorted = Object.keys(counts).sort(function(a, b) {
      return counts[b] - counts[a];
    });
    return parseInt(sorted[0]);
  }

  // === Modelo general ===
  function clamp(x, lo, hi) {
    return Math.max(lo, Math.min(hi, x));
  }

  function computeSoilMoistureIndex(dailyRain, dailyET0, Smax, infil, runoffCap) {
    if (!Smax) Smax = 80;
    if (!infil) infil = 0.8;
    if (!runoffCap) runoffCap = 25;
    let S = Smax * 0.5;
    const out = [];
    for (let i = 0; i < dailyRain.length; i++) {
      const effRain = Math.min(dailyRain[i] || 0, runoffCap) * infil;
      const et = Math.max(dailyET0[i] || 0, 0);
      S = clamp(S + effRain - et, 0, Smax);
      out.push(S / Smax);
    }
    return out;
  }

  function computeRainTrigger(dailyRain, windowDays, threshold, lagMin, lagMax) {
    if (!windowDays) windowDays = 2;
    if (!threshold) threshold = 25;
    if (!lagMin) lagMin = 6;
    if (!lagMax) lagMax = 12;
    const n = dailyRain.length;
    const trig = [];
    let last = -Infinity;
    for (let i = 0; i < n; i++) {
      const start = Math.max(0, i - windowDays + 1);
      let sum2 = 0;
      for (let j = start; j <= i; j++) {
        sum2 += dailyRain[j] || 0;
      }
      if (sum2 >= threshold) last = i;
      const d = i - last;
      if (d >= lagMin && d <= lagMax) {
        const mid = (lagMin + lagMax) / 2;
        const sigma = (lagMax - lagMin) / 4;
        trig[i] = Math.exp(-0.5 * Math.pow((d - mid) / sigma, 2));
      } else {
        trig[i] = 0;
      }
    }
    return trig;
  }

  function dewSpreadScore(T, Td) {
    const spread = Math.max(0, (T || 0) - (Td || 0));
    if (spread <= 2) return 1.0;
    if (spread <= 4) return 0.5;
    if (spread <= 6) return 0.0;
    return -0.5;
  }

  function smooth3(arr) {
    const out = [];
    for (let i = 0; i < arr.length; i++) {
      const p0 = arr[i];
      const p1 = i > 0 ? arr[i - 1] : p0;
      const p2 = i > 1 ? arr[i - 2] : p1;
      out.push(0.6 * p0 + 0.3 * p1 + 0.1 * p2);
    }
    return out;
  }

  const HABITAT_MULTIPLIER = { hayedo: 1.15, robledal_atlantico: 1.10, mixto_caducifolio: 1.08, pinar_silvestre: 1.00, carrascal: 0.85 };
  const AGE_MULTIPLIER = { maduro: 1.10, medio: 1.00, joven: 0.90 };
  const SOIL_MULTIPLIER = { acidofilo: 1.10, basofilo: 1.00 };

  function computeMushroomChances(dailyData, location, opts) {
    if (!opts) opts = {};
    const results = [];

    for (let i = 0; i < dailyData.length; i++) {
      results.push({
        ...dailyData[i],
        chance: "Baja",
        score: "0%",
        score_breakdown: [],
        smi: 0,
        tmed: 0,
        dewS: 0,
        baseProb: 0
      });
    }

    const rain = [];
    const et0 = [];
    const tmed = [];
    const td = [];
    const wind = [];

    for (let i = 0; i < dailyData.length; i++) {
      rain.push(dailyData[i].rain_for_day || 0);
      et0.push(dailyData[i].avg_et0 || 0);
      tmed.push((dailyData[i].temp_min + dailyData[i].temp_max) / 2);
      td.push(dailyData[i].avg_dew_point || 0);
      wind.push(dailyData[i].avg_wind_speed || 0);
    }

    const smi = computeSoilMoistureIndex(rain, et0, opts.Smax, opts.infil, opts.runoffCap);
    const trig = computeRainTrigger(rain, 2, opts.triggerThreshold, opts.lagMin, opts.lagMax);

    const rawScores = [];
    for (let i = 0; i < dailyData.length; i++) {
      let sc = 0;
      const bd = [];
      const sm = smi[i];

      if (sm >= 0.7) {
        sc += 2.5;
        bd.push("Suelo h√∫medo (SMI ‚â• 0.7) (+2.5)");
      } else if (sm >= 0.5) {
        sc += 1.5;
        bd.push("Suelo con humedad media (SMI ‚â• 0.5) (+1.5)");
      } else if (sm > 0.3) {
        sc += 0.5;
        bd.push("Suelo algo seco (SMI > 0.3) (+0.5)");
      } else {
        bd.push("Suelo seco (SMI ‚â§ 0.3)");
      }

      if (trig[i] > 0) {
        const add = 1.8 * trig[i];
        sc += add;
        bd.push("Brote tras lluvia reciente (+" + add.toFixed(1) + ")");
      }

      let last20 = 0;
      for (let j = Math.max(0, i - 19); j <= i; j++) last20 += rain[j] || 0;
      if (last20 >= 80) {
        sc += 1.2;
        bd.push("Reserva h√≠drica alta (‚â•80 mm/20d) (+1.2)");
      }

      let last30 = 0;
      for (let j = Math.max(0, i - 29); j <= i; j++) last30 += rain[j] || 0;
      if (last30 < 40) {
        sc -= 1.5;
        bd.push("Sequ√≠a prolongada (<40 mm/30d) (‚àí1.5)");
      }

      const t = tmed[i];
      const optMin = 8, optMax = 18;
      if (t >= optMin && t <= optMax) {
        sc += 1.2;
        bd.push("Temp. √≥ptima (8‚Äì18¬∞C) (+1.2)");
      } else if (t > 24) {
        sc -= 1.0;
        bd.push("Calor alto (>24¬∞C) (‚àí1.0)");
      }

      const ds = dewSpreadScore(t, td[i]);
      if (ds > 0) {
        sc += ds * 1.0;
        bd.push("Aire h√∫medo (roc√≠o) (+" + (ds*1.0).toFixed(1) + ")");
      } else if (ds < 0) {
        sc += ds;
        bd.push("Aire seco (" + ds.toFixed(1) + ")");
      }

      const avg3Wind = i >= 2 ? (wind[i] + wind[i-1] + wind[i-2]) / 3 : wind[i];
      const avg3Temp = i >= 2 ? (tmed[i] + tmed[i-1] + tmed[i-2]) / 3 : t;
      if (avg3Wind > 20 && avg3Temp > 20) {
        sc -= 1.5;
        bd.push("Viento+calor (‚àí1.5)");
      }

      const last7 = dailyData.slice(Math.max(0, i - 6), i + 1);
      let frost = 0;
      for (let j = 0; j < last7.length; j++) {
        if (last7[j].temp_min <= -2) frost++;
      }
      if (frost >= 2) {
        sc -= 1.5;
        bd.push("Heladas recientes (‚àí1.5)");
      }

      if (location.altitude) {
        const month = new Date(dailyData[i].date).getMonth();
        if (location.altitude < 800 && month < 8) {
          sc -= 1.0;
          bd.push("Zona baja y temporada temprana (‚àí1.0)");
        } else if (location.altitude > 1000) {
          sc -= 0.5;
          bd.push("Alta monta√±a (>1000 m) (‚àí0.5)");
        }
      }

      let mult = 1.0;
      if (location.habitat) mult *= (HABITAT_MULTIPLIER[location.habitat] || 1.0);
      if (location.ageClass) mult *= (AGE_MULTIPLIER[location.ageClass] || 1.0);
      if (location.soilAcidity) mult *= (SOIL_MULTIPLIER[location.soilAcidity] || 1.0);
      if (mult !== 1.0) bd.push("Factor de h√°bitat √ó" + mult.toFixed(2));
      sc *= mult;

      const prob = 1 / (1 + Math.exp(-(sc - 5.2)));
      const p = clamp(prob * 100, 0, 100);
      rawScores.push(p);

      results[i].smi = sm;
      results[i].tmed = t;
      results[i].dewS = ds;
      results[i].score_breakdown = bd;
    }

    const smoothed = smooth3(rawScores);
    for (let i = 0; i < results.length; i++) {
      const p = clamp(smoothed[i], 0, 100);
      results[i].score = p.toFixed(1) + '%';
      results[i].chance = p >= 75 ? "Alta" : (p >= 50 ? "Media" : "Baja");
      results[i].baseProb = p;
    }

    return results;
  }

  // === MODO ESPECIE ===
  function triangleSuitability(t, range) {
    const min = range[0], max = range[1];
    if (t <= min || t >= max) return 0;
    const mid = (min + max) / 2;
    return t <= mid ? (t - min) / (mid - min) : (max - t) / (max - mid);
  }

  function smiSuitability(smi, range) {
    const lo = range[0], hi = range[1];
    if (smi <= lo) return smi / lo * 0.6;
    if (smi >= hi) return 1;
    const r = (smi - lo) / (hi - lo);
    return 0.6 + 0.4 * r;
  }

  function dewSuitability(ds, bias) {
    let map;
    if (ds <= -0.25) map = 0.3;
    else if (ds <= 0) map = 0.5;
    else if (ds <= 0.75) map = 0.8;
    else map = 1;
    return clamp(map * (0.8 + 0.2 * bias), 0, 1);
  }

  function windPenalty(avgWind, bias) {
    return avgWind > 20 ? (1 - 0.2 * bias) : 1;
  }

  function computeSpeciesProbsForDay(day, location) {
    const avgWind = day.avg_wind_speed || 0;
    const habitat = location.habitat || '';
    const monthIdx = new Date(day.date).getMonth();
    const raw = {};

    for (const key in SPECIES) {
      const sp = SPECIES[key];
      const base = day.baseProb / 100;
      const wSeason = sp.seasonWeight(monthIdx);
      const wHab = habitat ? (sp.habitats[habitat] || 1.0) : 1.0;
      const wTemp = triangleSuitability(day.tmed, sp.temp);
      const wSmi = smiSuitability(day.smi, sp.smi);
      const wDew = dewSuitability(day.dewS, sp.dewBias);
      const wWind = windPenalty(avgWind, sp.windPenalty);
      const rawScore = base * wSeason * wHab * wTemp * wSmi * wDew * wWind;
      raw[key] = rawScore;
    }

    let sumRaw = 0;
    for (const k in raw) sumRaw += raw[k];
    if (sumRaw === 0) sumRaw = 1e-6;

    const speciesProbs = {};
    for (const k in raw) {
      speciesProbs[k] = (raw[k] / sumRaw) * day.baseProb;
    }

    const sorted = Object.keys(speciesProbs).sort(function(a, b) {
      return speciesProbs[b] - speciesProbs[a];
    });
    const topKey = sorted[0];

    return { speciesProbs: speciesProbs, topKey: topKey };
  }

  function annotateSpecies(location) {
    for (let i = 0; i < location.forecast.length; i++) {
      const day = location.forecast[i];
      const { speciesProbs, topKey } = computeSpeciesProbsForDay(day, location);
      day.species = speciesProbs;
      day.top_species = topKey;
    }
    return location;
  }

  // === Pipeline: fetch + compute ===
  async function updateLocationData(location) {
    try {
      const weatherData = await fetchWeather(location.lat, location.lon, 14, 9);
      const altitude = await fetchAltitude(location.lat, location.lon);
      const dailyData = processDailyData(weatherData);
      location.altitude = altitude;
      location.forecast = computeMushroomChances(dailyData, location);
      annotateSpecies(location);
      allForecastData.push(location);
      return location;
    } catch (error) {
      console.error('Error fetching data for ' + location.name + ':', error);
      showNotification('Errorea datuak kargatzean ' + location.name + '-(r)ako. / Error al cargar datos para ' + location.name + '.', 'error');
      return null;
    }
  }

  // === Render de tarjetas ===
  function renderLocationCard(location) {
    const todayDateString = todayLocalYYYYMMDD();
    let todayIndex = -1;
    for (let i = 0; i < location.forecast.length; i++) {
      if (location.forecast[i].date === todayDateString) {
        todayIndex = i;
        break;
      }
    }
    const effectiveTodayIndex = todayIndex !== -1 ? todayIndex : 0;
    const todayForecast = location.forecast[effectiveTodayIndex] || { chance: "Baja", score: "0%", top_species: null };

    const cardChanceClass = 'card-chance-' + todayForecast.chance;
    const cid = 'chart-' + slugify(location.name);
    const speciesCid = 'species-' + slugify(location.name);

    const topLabel = todayForecast.top_species ? SPECIES[todayForecast.top_species].label : '‚Äî';
    const topColor = todayForecast.top_species ? SPECIES[todayForecast.top_species].color : '#6B7280';

    const card = document.createElement('div');
    card.className = 'bg-white shadow-xl rounded-xl overflow-hidden transform transition-all duration-300 hover:scale-105 card-item ' + cardChanceClass;
    card.dataset.chance = todayForecast.chance;
    card.dataset.name = location.name;

    card.innerHTML = `
      <div class="p-6 relative">
        <div class="flex justify-between items-start mb-4">
          <div>
            <h4 class="text-2xl font-bold text-gray-800">${location.name}</h4>
            <div class="mt-1 flex items-center gap-2">
              <span class="chip" style="background:${SPECIES[todayForecast.top_species]?.light || '#E5E7EB'}; color:${topColor}">‚óè Hoberen gaur: ${topLabel}</span>
              <span class="chip" style="background:${SPECIES[todayForecast.top_species]?.light || '#E5E7EB'}; color:${topColor}">‚óè Mejor especie hoy: ${topLabel}</span>
            </div>
          </div>
          <div class="flex items-center space-x-2">
            <span class="px-3 py-1 text-sm font-bold text-white rounded-full ${todayForecast.chance === 'Alta' ? 'bg-green-600' : todayForecast.chance === 'Media' ? 'bg-yellow-600' : 'bg-red-600'}">${todayForecast.chance}</span>
            <button class="remove-location-btn p-2 text-gray-400 hover:text-red-600 text-lg" aria-label="Eliminar ubicaci√≥n" data-location-name="${location.name}">
              <svg class="h-6 w-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg>
            </button>
          </div>
        </div>
        <div class="w-full h-48 mb-4"><canvas id="${cid}"></canvas></div>
        <div class="mb-4">
          <h5 class="font-bold text-gray-800 mb-2">Especies por d√≠a (absoluto) ‚Äî l√≠nea = prob. base</h5>
          <div class="w-full h-40"><canvas id="${speciesCid}"></canvas></div>
        </div>
        <div class="full-forecast border-t border-gray-200 pt-4">
          <h5 class="font-bold text-gray-800 mb-2">Previsi√≥n para 7 d√≠as:</h5>
          <ul class="space-y-2">
          </ul>
        </div>
      </div>
    `;

    document.getElementById('grid').appendChild(card);

    const ul = card.querySelector('ul');
    for (let index = 0; index < 7; index++) {
      const i = effectiveTodayIndex + index;
      if (i >= location.forecast.length) break;
      const day = location.forecast[i];
      const topK = day.top_species;
      const sp = topK ? SPECIES[topK] : null;
      const chip = sp ? `<span class="chip" style="background:${sp.light}; color:${sp.color}">‚óè ${sp.label}</span>` : '';

      const li = document.createElement('li');
      li.className = 'flex flex-col text-sm text-gray-600 border-b border-gray-200 last:border-b-0 py-2';
      li.innerHTML = `
        <div class="flex justify-between items-center">
          <div class="flex-1 flex flex-wrap items-center gap-2 pr-2">
            <span class="font-semibold">${new Date(day.date).toLocaleDateString('es-ES', { weekday: 'short', month: 'short', day: 'numeric' })}</span>
            <span class="font-semibold text-gray-800">${getWeatherIcon(day.weather_code)} ${day.temp_min.toFixed(0)}¬∞C - ${day.temp_max.toFixed(0)}¬∞C</span>
            <span class="font-semibold text-gray-800">${day.rain_for_day.toFixed(1)}mm</span>
            ${chip}
          </div>
          <div class="flex items-center space-x-2">
            <span class="px-2 py-1 text-xs font-bold rounded-full ${day.chance === 'Alta' ? 'bg-green-600 text-white' : day.chance === 'Media' ? 'bg-yellow-600 text-white' : 'bg-red-600 text-white'}">${day.chance}</span>
            <button class="toggle-score-btn text-gray-400 hover:text-green-600 text-lg" data-target-id="score-details-${slugify(location.name)}-${index}">&#9432;</button>
          </div>
        </div>
        <div id="score-details-${slugify(location.name)}-${index}" class="score-breakdown-details text-xs mt-2 w-full pl-4 hidden">
          <p class="font-bold text-gray-700">Puntuaci√≥n: <span class="text-green-800">${day.score}</span></p>
          <ul class="score-breakdown text-xs text-gray-600 ${day.score_breakdown.length === 0 ? 'no-score' : ''}"></ul>
        </div>
      `;
      ul.appendChild(li);

      const breakdownUl = li.querySelector('.score-breakdown');
      for (let j = 0; j < day.score_breakdown.length; j++) {
        const item = document.createElement('li');
        item.textContent = day.score_breakdown[j];
        breakdownUl.appendChild(item);
      }
    }

    // Gr√°fico de temperatura, lluvia y ET
    const historyData = [];
    for (let i = Math.max(0, effectiveTodayIndex - 7); i < effectiveTodayIndex; i++) {
      historyData.push(location.forecast[i]);
    }

    const dates = historyData.map(d => new Date(d.date).toLocaleDateString('es-ES', { day: 'numeric', month: 'short' }));
    const temps = historyData.map(d => (d.temp_min + d.temp_max) / 2);
    const rain = historyData.map(d => d.rain_for_day);
    const et0 = historyData.map(d => d.avg_et0 || 0);

    new Chart(document.getElementById(cid), {
      type: 'bar',
      data: {
        labels: dates,
        datasets: [
          { type: 'line', label: 'Temp. (¬∞C)', data: temps, borderColor: '#22C55E', borderWidth: 2, fill: false, yAxisID: 'y-temp', tension: 0.4 },
          { type: 'bar', label: 'Lluvia (mm)', data: rain, backgroundColor: '#3B82F6', yAxisID: 'y-rain' },
          { type: 'bar', label: 'ET (mm)', data: et0, backgroundColor: '#F59E0B', yAxisID: 'y-et0' }
        ]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        scales: {
          x: { grid: { display: false }, ticks: { maxRotation: 45, minRotation: 45, font: { size: window.innerWidth < 640 ? 8 : 10 } } },
          'y-temp': { type: 'linear', display: true, position: 'left', title: { display: true, text: 'Temp. (¬∞C)', font: { size: 10 } }, min: Math.min.apply(null, temps.concat([0])) - 5, max: Math.max.apply(null, temps) + 5, ticks: { font: { size: 8 } } },
          'y-rain': { type: 'linear', display: true, position: 'right', title: { display: true, text: 'Lluvia (mm)', font: { size: 10 } }, grid: { drawOnChartArea: false }, min: 0, max: Math.max.apply(null, rain) > 0 ? Math.max.apply(null, rain) * 1.2 : 5, ticks: { font: { size: 8 } } },
          'y-et0': { type: 'linear', display: true, position: 'right', title: { display: true, text: 'ET (mm)', font: { size: 10 } }, grid: { drawOnChartArea: false }, min: 0, max: Math.max.apply(null, et0) > 0 ? Math.max.apply(null, et0) * 1.5 : 5, ticks: { font: { size: 8 } } }
        },
        plugins: {
          legend: { display: true, position: 'top', labels: { font: { size: 10 }, boxWidth: 15, padding: 10 } },
          tooltip: {
            enabled: true, mode: 'index', intersect: false,
            callbacks: {
              label: function(c) {
                let label = c.dataset.label || '';
                if (label) label += ': ';
                label += c.parsed.y.toFixed(1);
                label += c.dataset.label.includes('mm') ? ' mm' : ' ¬∞C';
                return label;
              }
            }
          }
        }
      }
    });

    // Gr√°fico de especies
    const next7 = [];
    for (let i = effectiveTodayIndex; i < effectiveTodayIndex + 7; i++) {
      if (i < location.forecast.length) next7.push(location.forecast[i]);
    }

    const dayLabels = next7.map(d => new Date(d.date).toLocaleDateString('es-ES', { weekday: 'short' }));
    const speciesKeys = Object.keys(SPECIES);
    const stackedDatasets = [];
    for (let i = 0; i < speciesKeys.length; i++) {
      const k = speciesKeys[i];
      const data = next7.map(d => (d.species && d.species[k]) || 0);
      stackedDatasets.push({
        label: SPECIES[k].label,
        data: data,
        backgroundColor: SPECIES[k].color,
        stack: 'sp'
      });
    }

    const baseLine = {
      type: 'line',
      label: 'Probabilidad base',
      data: next7.map(d => d.baseProb),
      borderColor: '#9CA3AF',
      borderWidth: 2,
      pointRadius: 0,
      yAxisID: 'y'
    };

    new Chart(document.getElementById(speciesCid), {
      type: 'bar',
      data: { labels: dayLabels, datasets: stackedDatasets.concat([baseLine]) },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        scales: { 
          x: { stacked: true }, 
          y: { stacked: true, max: 100, ticks: { callback: function(v) { return v + '%'; } } } 
        },
        plugins: {
          legend: { display: false },
          tooltip: {
            callbacks: {
              label: function(c) {
                if (c.dataset.type === 'line') {
                  return 'Base: ' + c.parsed.y.toFixed(1) + '%';
                } else {
                  return c.dataset.label + ': ' + c.parsed.y.toFixed(1) + '%';
                }
              }
            }
          }
        }
      }
    });

    // Leyenda compacta
    (function() {
      const canvasEl = document.getElementById(speciesCid);
      const host = canvasEl.parentElement || card;
      const legend = document.createElement('div');
      legend.className = 'mt-1';
      const chips = [];
      for (let i = 0; i < speciesKeys.length; i++) {
        const k = speciesKeys[i];
        const sp = SPECIES[k];
        chips.push(`<span class="chip" style="background:${sp.light}; color:${sp.color}">‚óè ${sp.label}</span>`);
      }
      legend.innerHTML = `<details class="text-xs text-gray-600"><summary class="cursor-pointer">Leyenda</summary><div class="flex flex-wrap gap-2 mt-2">${chips.join(' ')}</div></details>`;
      host.appendChild(legend);
    })();

    card.querySelector('.remove-location-btn').addEventListener('click', function(e) {
      const name = e.currentTarget.dataset.locationName;
      LOCATIONS = LOCATIONS.filter(l => l.name !== name);
      allForecastData = allForecastData.filter(l => l.name !== name);
      saveLocations();
      refreshGrid();
    });
  }

  function refreshGrid() {
    const grid = document.getElementById('grid');
    grid.innerHTML = '';
    const todayDateString = todayLocalYYYYMMDD();
    const filtered = [];
    for (let i = 0; i < allForecastData.length; i++) {
      const loc = allForecastData[i];
      let ch = 'Baja';
      const dayIndex = loc.forecast.findIndex(d => d.date === todayDateString);
      const idx = dayIndex !== -1 ? dayIndex : 0;
      if (loc.forecast[idx]) ch = loc.forecast[idx].chance;
      if (currentFilter === 'all' || ch === currentFilter) {
        filtered.push(loc);
      }
    }

    if (filtered.length === 0 && allForecastData.length > 0) {
      grid.innerHTML = '<p class="text-center text-gray-500 col-span-full">Ez dago kokapenik filtroarekin bat egiten duenik. / No hay ubicaciones que coincidan con el filtro \'' + currentFilter + '\'.<\/p>';
    } else if (allForecastData.length === 0) {
      document.getElementById('welcome-message').classList.remove('hidden');
    } else {
      document.getElementById('welcome-message').classList.add('hidden');
      filtered.sort(function(a, b) {
        const today = todayLocalYYYYMMDD();
        let aC = 'Baja', bC = 'Baja';
        const aF = a.forecast.find(d => d.date === today);
        const bF = b.forecast.find(d => d.date === today);
        if (aF) aC = aF.chance;
        if (bF) bC = bF.chance;
        if (currentSort === 'chance') {
          if (aC === bC) return a.name.localeCompare(b.name);
          if (aC === 'Alta') return -1;
          if (bC === 'Alta') return 1;
          if (aC === 'Media') return -1;
          return 1;
        }
        return a.name.localeCompare(b.name);
      });
      for (let i = 0; i < filtered.length; i++) {
        renderLocationCard(filtered[i]);
      }
    }
  }

  function saveLocations() {
    localStorage.setItem('mushroomLocations', JSON.stringify(LOCATIONS));
  }

  async function loadLocations() {
    const saved = localStorage.getItem('mushroomLocations');
    if (saved) {
      try {
        LOCATIONS = JSON.parse(saved);
      } catch (e) {
        LOCATIONS = DEFAULT_LOCATIONS;
      }
    } else {
      LOCATIONS = DEFAULT_LOCATIONS;
    }
    document.getElementById('loading-message').classList.remove('hidden');
    const promises = [];
    for (let i = 0; i < LOCATIONS.length; i++) {
      promises.push(updateLocationData(LOCATIONS[i]));
    }
    try {
      await Promise.all(promises);
      document.getElementById('loading-message').classList.add('hidden');
      refreshGrid();
    } catch (e) {
      console.error('load locations', e);
      document.getElementById('loading-message').classList.add('hidden');
      showNotification('Errorea kokapenak kargatzean. / Error al cargar las ubicaciones.', 'error');
    }
  }

  // === Luna ===
  function getMoonPhase(date) {
    const jul = date.getTime() / 86400000 + 2440587.5;
    const cycle = 29.53058867;
    const new1970 = 2440409.5;
    const diff = jul - new1970;
    const phase = diff % cycle;
    return phase / cycle;
  }

  function getMoonData(date) {
    const v = getMoonPhase(date);
    let idx = Math.floor(v * 8);
    if (idx === 8) idx = 0;
    const current = MOON_PHASES[idx];
    let next = new Date(date);
    let d = 0;
    let found = false;
    while (!found) {
      d++;
      next.setDate(date.getDate() + d);
      const nv = getMoonPhase(next);
      const ni = Math.floor(nv * 8);
      if (ni === 4) found = true;
    }
    return { currentPhase: current, nextFullMoonDate: next };
  }

  function renderMoonPhase() {
    const today = new Date();
    const m = getMoonData(today);
    document.getElementById('moon-emoji').textContent = m.currentPhase.emoji;
    document.getElementById('moon-phase-name').textContent = m.currentPhase.name;
    document.getElementById('next-full-moon').textContent = `Hurrengo ilargi betea: ${m.nextFullMoonDate.toLocaleDateString('es-ES', { day: 'numeric', month: 'long' })} / Pr√≥xima luna llena: ${m.nextFullMoonDate.toLocaleDateString('es-ES', { day: 'numeric', month: 'long' })}`;
  }

  // === Eventos DOM ===
  document.addEventListener('DOMContentLoaded', function() {
    loadLocations();
    renderMoonPhase();
    const filterBtns = document.querySelectorAll('.filter-btn');
    for (let i = 0; i < filterBtns.length; i++) {
      if (filterBtns[i].dataset.filter === currentFilter) {
        filterBtns[i].classList.add('bg-gray-400', 'text-white');
      }
    }
    const sortBtns = document.querySelectorAll('.sort-btn');
    for (let i = 0; i < sortBtns.length; i++) {
      if (sortBtns[i].dataset.sort === currentSort) {
        sortBtns[i].classList.add('bg-gray-400', 'text-white');
      }
    }
  });

  const searchButton = document.getElementById('search-button');
  const locationNameInput = document.getElementById('location-name');
  const searchResultsDiv = document.getElementById('search-results');
  const searchStatusP = document.getElementById('search-status');
  const addLocationBtn = document.getElementById('add-location-btn');
  const habitatSelect = document.getElementById('habitat-select');
  const ageSelect = document.getElementById('age-select');
  const soilSelect = document.getElementById('soil-select');
  let foundLocation = null;

  searchButton.addEventListener('click', async function() {
    const query = locationNameInput.value.trim();
    if (query === '') {
      showNotification('Mesedez, sartu kokaleku-izen bat. / Por favor, introduce un nombre de ubicaci√≥n.', 'warning');
      return;
    }
    searchStatusP.innerHTML = `Bilatzen <b>${query}</b>... <span class="loading-spinner inline-block align-middle ml-2"></span><br />Buscando <b>${query}</b>... <span class="loading-spinner inline-block align-middle ml-2"></span>`;
    searchResultsDiv.classList.remove('hidden');
    addLocationBtn.classList.add('hidden');
    addLocationBtn.textContent = 'Gehitu "Nire Lekuetara" / A√±adir a Mis Lugares';
    try {
      const bbox = REGION_BBOX.minLon + ',' + REGION_BBOX.minLat + ',' + REGION_BBOX.maxLon + ',' + REGION_BBOX.maxLat;
      const url = `${NOMINATIM_API_URL}?q=${encodeURIComponent(query)}&format=json&limit=1&bounded=1&viewbox=${bbox}&addressdetails=1&namedetails=1`;
      const r = await fetch(url);
      const data = await r.json();
      if (data && data.length > 0) {
        const loc = data[0];
        const lat = parseFloat(loc.lat);
        const lon = parseFloat(loc.lon);
        if (lat >= REGION_BBOX.minLat && lat <= REGION_BBOX.maxLat && lon >= REGION_BBOX.minLon && lon <= REGION_BBOX.maxLon) {
          const name = loc.namedetails && loc.namedetails["name:eu"] ? loc.namedetails["name:eu"] : loc.display_name.split(',')[0];
          const province = loc.address ? (loc.address.state || loc.address.province || "") : "";
          const municipality = loc.address ? (loc.address.town || loc.address.city || loc.address.village || "") : "";
          const country = loc.address ? loc.address.country || "" : "";
          foundLocation = {
            name: name,
            lat: lat,
            lon: lon,
            province: province,
            municipality: municipality,
            country: country
          };
          searchStatusP.innerHTML = `
            <b>${name}</b><br>
            Probintzia: ${province || "‚Äî"} / Provincia: ${province || "‚Äî"}<br>
            Udala: ${municipality || "‚Äî"} / Municipio: ${municipality || "‚Äî"}<br>
            Herrialdea: ${country || "‚Äî"} / Pa√≠s: ${country || "‚Äî"}<br>
            Koordenatuak: (Lat: ${lat.toFixed(4)}, Lon: ${lon.toFixed(4)})
          `;
          addLocationBtn.textContent = `Gehitu "${name}" / A√±adir "${name}"`;
          addLocationBtn.classList.remove('hidden');
        } else {
          searchStatusP.textContent = 'Kokapena Euskal Herriko ingurunetik kanpo dago. Saiatu beste batekin. / La ubicaci√≥n est√° fuera del entorno del norte de Espa√±a. Intente con otra.';
          foundLocation = null;
        }
      } else {
        searchStatusP.textContent = 'Kokapena ez da aurkitu. Saiatu berriro. / Ubicaci√≥n no encontrada. Intente ser m√°s espec√≠fico.';
        foundLocation = null;
      }
    } catch (e) {
      searchStatusP.textContent = 'Errorea kokapena bilatzean. / Error al buscar la ubicaci√≥n.';
      console.error(e);
      foundLocation = null;
    }
  });

  addLocationBtn.addEventListener('click', async function() {
    if (foundLocation) {
      const exists = LOCATIONS.some(loc => loc.name === foundLocation.name);
      if (!exists) {
        const newLoc = {
          name: foundLocation.name,
          lat: foundLocation.lat,
          lon: foundLocation.lon,
          province: foundLocation.province,
          municipality: foundLocation.municipality,
          country: foundLocation.country
        };
        if (habitatSelect.value) newLoc.habitat = habitatSelect.value;
        if (ageSelect.value) newLoc.ageClass = ageSelect.value;
        if (soilSelect.value) newLoc.soilAcidity = soilSelect.value;
        LOCATIONS.push(newLoc);
        saveLocations();
        locationNameInput.value = '';
        habitatSelect.value = '';
        ageSelect.value = '';
        soilSelect.value = '';
        searchResultsDiv.classList.add('hidden');
        document.getElementById('loading-message').classList.remove('hidden');
        const result = await updateLocationData(newLoc);
        document.getElementById('loading-message').classList.add('hidden');
        if (result) refreshGrid();
      } else {
        searchStatusP.textContent = 'Kokapen hau jada zerrendan dago. / Esta ubicaci√≥n ya est√° en su lista.';
      }
    }
  });

  const filterButtons = document.querySelectorAll('.filter-btn');
  for (let i = 0; i < filterButtons.length; i++) {
    filterButtons[i].addEventListener('click', function(e) {
      for (let j = 0; j < filterButtons.length; j++) {
        filterButtons[j].classList.remove('bg-gray-400', 'text-white');
      }
      e.target.classList.add('bg-gray-400', 'text-white');
      currentFilter = e.target.dataset.filter;
      refreshGrid();
    });
  }

  const sortButtons = document.querySelectorAll('.sort-btn');
  for (let i = 0; i < sortButtons.length; i++) {
    sortButtons[i].addEventListener('click', function(e) {
      for (let j = 0; j < sortButtons.length; j++) {
        sortButtons[j].classList.remove('bg-gray-400', 'text-white');
      }
      e.target.classList.add('bg-gray-400', 'text-white');
      currentSort = e.target.dataset.sort;
      refreshGrid();
    });
  }

  const helpButton = document.getElementById('help-button');
  const helpModal = document.getElementById('help-modal');
  const closeButton = document.querySelector('.close');

  helpButton.onclick = function() { helpModal.style.display = "block"; };
  closeButton.onclick = function() { helpModal.style.display = "none"; };
  window.onclick = function(event) { if (event.target == helpModal) helpModal.style.display = "none"; };

  document.addEventListener('click', function(e) {
    if (e.target.classList.contains('toggle-score-btn')) {
      const id = e.target.dataset.targetId;
      const el = document.getElementById(id);
      if (el) el.classList.toggle('hidden');
    }
  });
</script>
</body>
</html>
